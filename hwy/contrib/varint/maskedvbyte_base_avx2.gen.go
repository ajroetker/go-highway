// Code generated by hwygen. DO NOT EDIT.
//go:build amd64 && goexperiment.simd

package varint

import (
	"github.com/ajroetker/go-highway/hwy"
	"simd/archsimd"
)

func BaseMaskedVByteDecodeBatch32_avx2(src []byte, dst []uint32, n int) (decoded int, consumed int) {
	if len(src) == 0 || n == 0 || len(dst) == 0 {
		return 0, 0
	}
	maxDecode := min(n, len(dst))
	pos := 0
	for decoded+4 <= maxDecode && pos+16 <= len(src) {
		numDecoded, bytesUsed := BaseMaskedVByteDecodeGroup_avx2(src[pos:], dst[decoded:])
		if numDecoded == 0 {
			break
		}
		decoded += numDecoded
		pos += bytesUsed
	}
	for decoded < maxDecode && pos < len(src) {
		val, bytesRead := baseMaskedVByteDecodeOne32(src[pos:])
		if bytesRead == 0 {
			break
		}
		dst[decoded] = val
		decoded++
		pos += bytesRead
	}
	return decoded, pos
}

func BaseMaskedVByteDecodeGroup_avx2(src []byte, dst []uint32) (decoded int, consumed int) {
	if len(src) < 16 || len(dst) < 4 {
		return 0, 0
	}
	srcVec := archsimd.LoadUint8x16Slice(src[:16])
	highBitMask := hwy.TestBit(srcVec, 7)
	var pattern uint16
	for i := 0; i < 12; i++ {
		if !func() bool {
			_vOne := archsimd.BroadcastInt32x32(1)
			_vZero := archsimd.BroadcastInt32x32(0)
			_vMasked := _vOne.Merge(_vZero, highBitMask)
			var _simd_mask_tmp [32]int32
			_vMasked.StoreSlice(_simd_mask_tmp[:])
			return _simd_mask_tmp[i] != 0
		}() {
			pattern |= 1 << i
		}
	}
	if pattern == 0 {
		return 0, 0
	}
	lookup := &maskedVByte12LookupTable[pattern]
	if lookup.numValues == 0 {
		return 0, 0
	}
	shuffleMask := maskedVByte12ShuffleMasks[pattern][:]
	maskVec := archsimd.LoadUint8x16Slice(shuffleMask)
	shuffled := hwy.TableLookupBytes_AVX2_Uint8x16(srcVec, maskVec)
	var result [16]uint8
	shuffled.StoreSlice(result[:])
	numVals := int(lookup.numValues)
	start := 0
	for i := 0; i < numVals; i++ {
		end := int(lookup.valueEnds[i])
		length := end - start
		dst[i] = maskedVByteCombine(result[i*4:i*4+4], length)
		start = end
	}
	return numVals, int(lookup.bytesConsumed)
}
