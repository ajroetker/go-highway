// Copyright 2025 go-highway Authors
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//     http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

//go:build !noasm && arm64

// SME UMOPA single-tile kernel wrappers for ARM64.
// Computes a 16×16 int32 tile using UMOPA (uint8×uint8→int32 outer product).
package asm

import "unsafe"

// Generate assembly from C using goat
// -march=armv9-a+sme+sme-i16i64 enables SME with integer 8-bit outer products
//go:generate go tool goat ../c/block_kernel_umopa_arm64.c -O3 --target arm64 --target-os darwin -e="-march=armv9-a+sme+sme-i16i64"

// TileUMOPAU8 computes a single 16×16 int32 output tile using SME UMOPA.
//
// aPanel and bPanel must be pre-packed in UMOPA interleaved format:
//
//	panel[k4 * 64 + lane * 4 + g] = value for (tile_lane, k_index = k4*4 + g)
//
// where lane ∈ [0,16), g ∈ [0,4), k4 ∈ [0, kGroups).
//
// c must have length >= 256 (16×16 int32), written with stride 16.
// kGroups is the number of K/4 groups (K must be pre-padded to a multiple of 4).
func TileUMOPAU8(aPanel, bPanel []uint8, c []int32, kGroups int) {
	if kGroups == 0 {
		return
	}
	panelSize := kGroups * 64
	if len(aPanel) < panelSize {
		panic("TileUMOPAU8: aPanel too short")
	}
	if len(bPanel) < panelSize {
		panic("TileUMOPAU8: bPanel too short")
	}
	if len(c) < 256 {
		panic("TileUMOPAU8: c slice too short (need 16×16 = 256)")
	}
	tile_umopa_u8(
		unsafe.Pointer(&aPanel[0]),
		unsafe.Pointer(&bPanel[0]),
		unsafe.Pointer(&c[0]),
		int64(kGroups),
	)
}

// Assembly function declarations are in block_kernel_umopa_arm64.go (generated by GoAT)
