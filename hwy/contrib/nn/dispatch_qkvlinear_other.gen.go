// Code generated by github.com/ajroetker/go-highway/cmd/hwygen. DO NOT EDIT.

//go:build !arm64 && !(amd64 && goexperiment.simd)

package nn

import (
	"github.com/ajroetker/go-highway/hwy"
)

var QKVLinearFloat16 func(x []hwy.Float16, wQKV []hwy.Float16, biasQ []hwy.Float16, biasK []hwy.Float16, biasV []hwy.Float16, q []hwy.Float16, k []hwy.Float16, v []hwy.Float16, batchSize int, inFeatures int, qDim int, kvDim int)
var QKVLinearBFloat16 func(x []hwy.BFloat16, wQKV []hwy.BFloat16, biasQ []hwy.BFloat16, biasK []hwy.BFloat16, biasV []hwy.BFloat16, q []hwy.BFloat16, k []hwy.BFloat16, v []hwy.BFloat16, batchSize int, inFeatures int, qDim int, kvDim int)
var QKVLinearFloat32 func(x []float32, wQKV []float32, biasQ []float32, biasK []float32, biasV []float32, q []float32, k []float32, v []float32, batchSize int, inFeatures int, qDim int, kvDim int)
var QKVLinearFloat64 func(x []float64, wQKV []float64, biasQ []float64, biasK []float64, biasV []float64, q []float64, k []float64, v []float64, batchSize int, inFeatures int, qDim int, kvDim int)

// QKVLinear computes a fused QKV projection: a single matmul against stacked
// Q/K/V weights, then splits and adds per-segment biases.
//
//   - x:      [batchSize, inFeatures] (row-major)
//   - wQKV:   [(qDim + 2*kvDim), inFeatures] (row-major, stacked Q, K, V weights)
//   - biasQ:  [qDim] (optional, pass nil to skip)
//   - biasK:  [kvDim] (optional, pass nil to skip)
//   - biasV:  [kvDim] (optional, pass nil to skip)
//   - q:      [batchSize, qDim] output
//   - k:      [batchSize, kvDim] output
//   - v:      [batchSize, kvDim] output
//
// This fuses the matmul, scatter, and bias-add into a single pass, avoiding
// a temporary buffer and separate scatter copy. Each output row is computed
// via SIMD dot-product accumulation with 4-row unrolling on batchSize.
//
// This function dispatches to the appropriate SIMD implementation at runtime.
func QKVLinear[T hwy.Floats](x []T, wQKV []T, biasQ []T, biasK []T, biasV []T, q []T, k []T, v []T, batchSize int, inFeatures int, qDim int, kvDim int) {
	switch any(x).(type) {
	case []hwy.Float16:
		QKVLinearFloat16(any(x).([]hwy.Float16), any(wQKV).([]hwy.Float16), any(biasQ).([]hwy.Float16), any(biasK).([]hwy.Float16), any(biasV).([]hwy.Float16), any(q).([]hwy.Float16), any(k).([]hwy.Float16), any(v).([]hwy.Float16), batchSize, inFeatures, qDim, kvDim)
	case []hwy.BFloat16:
		QKVLinearBFloat16(any(x).([]hwy.BFloat16), any(wQKV).([]hwy.BFloat16), any(biasQ).([]hwy.BFloat16), any(biasK).([]hwy.BFloat16), any(biasV).([]hwy.BFloat16), any(q).([]hwy.BFloat16), any(k).([]hwy.BFloat16), any(v).([]hwy.BFloat16), batchSize, inFeatures, qDim, kvDim)
	case []float32:
		QKVLinearFloat32(any(x).([]float32), any(wQKV).([]float32), any(biasQ).([]float32), any(biasK).([]float32), any(biasV).([]float32), any(q).([]float32), any(k).([]float32), any(v).([]float32), batchSize, inFeatures, qDim, kvDim)
	case []float64:
		QKVLinearFloat64(any(x).([]float64), any(wQKV).([]float64), any(biasQ).([]float64), any(biasK).([]float64), any(biasV).([]float64), any(q).([]float64), any(k).([]float64), any(v).([]float64), batchSize, inFeatures, qDim, kvDim)
	}
}

func init() {
	_ = hwy.NoSimdEnv // silence unused import
	initQkvlinearFallback()
}

func initQkvlinearFallback() {
	QKVLinearFloat16 = BaseQKVLinear_fallback_Float16
	QKVLinearBFloat16 = BaseQKVLinear_fallback_BFloat16
	QKVLinearFloat32 = BaseQKVLinear_fallback
	QKVLinearFloat64 = BaseQKVLinear_fallback_Float64
}
